i just migrated .net core 2.0 to .net core 2.1. everything went fine, but when i try to login now i get the folowing error:


  
  $exception  {system.objectdisposedexception: cannot access a disposed object.
  object name: 'iserviceprovider'.
  


this happens in this bit of code:

public class appcontractresolver : defaultcontractresolver
{

    private readonly iserviceprovider _services;

    public appcontractresolver(iserviceprovider services)
    {
        _services = services;
    }

    protected override ilist&lt;jsonproperty&gt; createproperties(type type, memberserialization memberserialization)
    {
        var httpcontextaccessor = _services.getservice&lt;ihttpcontextaccessor&gt;();
        var user = httpcontextaccessor.httpcontext.user;

        list&lt;jsonproperty&gt; properies = base.createproperties(type, memberserialization).tolist();

        properies = filteroneclaimgranted(type, properies, user);

        return properies;
    }


it happens on this line:

var httpcontextaccessor = _services.getservice&lt;ihttpcontextaccessor&gt;();


this did work on .net core 2.0 

i have tried adding the httpcontextaccessor to my startup, but that did not work.

so, how do i fix this?

let me know if you need more code. i will happily provide more, but i don't know what you might or might not need, so therefor i did not add a lot of code.'

edit 

i have added services.addhttpcontextaccessor(); to my startup, but that does not seem to work. still getting the error.

edit 2:

full stacktrace:

- $exception    {system.objectdisposedexception: cannot access a disposed object.
object name: 'iserviceprovider'.
   at microsoft.extensions.dependencyinjection.servicelookup.throwhelper.throwobjectdisposedexception()
   at microsoft.extensions.dependencyinjection.servicelookup.serviceproviderenginescope.getservice(type servicetype)
   at microsoft.extensions.dependencyinjection.serviceproviderserviceextensions.getservice[t](iserviceprovider provider)
   at webapi.extensions.appcontractresolver.createproperties(type type, memberserialization memberserialization) in c:\users\luukw\desktop\stage\blacky-api\blacky\extensions\resolver\appcontractresolver.cs:line 25
   at newtonsoft.json.serialization.defaultcontractresolver.createobjectcontract(type objecttype)
   at newtonsoft.json.serialization.defaultcontractresolver.createcontract(type objecttype)
   at system.collections.concurrent.concurrentdictionary`2.getoradd(tkey key, func`2 valuefactory)
   at newtonsoft.json.serialization.defaultcontractresolver.resolvecontract(type type)
   at newtonsoft.json.serialization.jsonserializerinternalreader.getcontractsafe(type type)
   at newtonsoft.json.serialization.jsonserializerinternalreader.deserialize(jsonreader reader, type objecttype, boolean checkadditionalcontent)
   at newtonsoft.json.jsonserializer.deserializeinternal(jsonreader reader, type objecttype)
   at newtonsoft.json.jsonserializer.deserialize(jsonreader reader, type objecttype)
   at microsoft.aspnetcore.mvc.formatters.jsoninputformatter.readrequestbodyasync(inputformattercontext context, encoding encoding)}    system.objectdisposedexception

